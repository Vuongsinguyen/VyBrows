---
import { getCollection } from "astro:content";
import ProjectCard from '../cards/ProjectCard.astro';

const categories = [
  { name: "All", key: "All" },
  { name: "Web", key: "Web" },
  { name: "Mobile", key: "Mobile" },
  { name: "Enterprise", key: "Enterprise" }
];

const lang = (Astro.props?.lang || Astro.url.pathname.split('/')[1] || 'en') as 'en' | 'vi' | 'ja' | 'ko' | 'es';
const allProjects = (await getCollection("projects")).filter(p => p.id.endsWith(`.${lang}.md`));
const projects: Record<string, any[]> = {};
projects["All"] = allProjects.map(p => {
  const slug = p.id
    .replace(/^projects\//, '')
    .replace(/\.(en|vi|ja)\.md$/, '')
    .replace(/\.md$/, '');
  return {
    ...p.data,
    href: `/${lang}/projects/${slug}`
  };
});
for (const cat of categories) {
  if (cat.key !== "All") {
    projects[cat.key] = allProjects
      .filter(p => p.data.category === cat.key)
      .map(p => {
        const slug = p.id
          .replace(/^projects\//, '')
          .replace(/\.(en|vi|ja)\.md$/, '')
          .replace(/\.md$/, '');
        return {
          ...p.data,
          href: `/${lang}/projects/${slug}`
        };
      });
  }
}
---

<section id="pmu-training" class="py-16 px-4" style="background: var(--color-bg);">
  <div class="max-w-7xl mx-auto">
    <h2 class="text-4xl md:text-5xl font-bold text-center mb-8 font-lora" style="color: var(--color-blacktext); font-family: 'Lora', serif;">
      {({
        en: "PMU Training & Academy",
        vi: "ĐÀO TẠO & HỌC VIỆN PHUN XĂM",
        ja: "PMUトレーニング＆アカデミー",
        ko: "PMU 트레이닝 & 아카데미",
        es: "Academia y Formación PMU"
      })[lang]}
    </h2>
    <p class="text-lg text-center mb-10 font-lora" style="color: var(--color-blacktext); font-family: 'Lora', serif; max-width:700px; margin:0 auto;">
      {({
        en: "At VyBrows Academy, permanent makeup is a blend of art and science, perfected to enhance natural beauty. Our highly trained team upholds the highest standards of hygiene and professionalism, ensuring comfort and safety in all our procedures.",
        vi: "Tại VyBrows Academy, phun xăm thẩm mỹ là sự kết hợp giữa nghệ thuật và khoa học, được hoàn thiện để tôn vinh vẻ đẹp tự nhiên. Đội ngũ chuyên gia của chúng tôi luôn tuân thủ tiêu chuẩn vệ sinh và chuyên nghiệp cao nhất, đảm bảo sự thoải mái và an toàn trong mọi quy trình.",
        ja: "ヴィブロウズ・アカデミーでは、アートメイクは芸術と科学の融合であり、自然な美しさを引き立てるために磨き上げられています。経験豊富なチームが最高水準の衛生管理とプロフェッショナルな技術で、すべての施術において安心と快適さを提供します。",
        ko: "VyBrows 아카데미에서는 반영구 화장은 예술과 과학의 조화로, 자연스러운 아름다움을 완성합니다. 전문 교육을 받은 팀이 최고 수준의 위생과 전문성을 지켜 모든 시술에서 편안함과 안전을 보장합니다.",
        es: "En VyBrows Academy, el maquillaje permanente es una combinación de arte y ciencia, perfeccionada para realzar la belleza natural. Nuestro equipo altamente capacitado mantiene los más altos estándares de higiene y profesionalismo, garantizando comodidad y seguridad en todos los procedimientos."
      })[lang]}
    </p>

    <div class="w-full flex justify-center mt-6 px-3 md:mt-10 md:px-0">
      <div
        class="flex flex-col md:flex-row gap-[5px] project-container
               mx-0 md:mx-[30px]"
        style="max-width:1180px; width:100%;"
      >
        {projects["All"].slice(0, 5).map((proj, idx) => {
          const isWide = idx === 2; // card thứ 3 là card lớn
          const isColor = idx === 2; // card 3 có màu từ đầu
          // clone props so we can override images
          const cardProps = { ...proj };

          // override text
          if (idx === 0) {
            cardProps.name = 'Emily Bui';
            cardProps.category = 'GENERAL MANAGER / INSTRUCTOR';
          }
          if (idx === 1) {
            cardProps.name = 'Kim Nguyen';
            cardProps.category = 'VICE PRESIDENT / INSTRUCTOR';
          }
          if (idx === 2) {
            cardProps.name = 'Vy Nguyen';
            cardProps.category = 'CEO / FOUNDER / INSTRUCTOR';
          }
          if (idx === 3) {
            cardProps.name = 'Nguyen Vuong';
            cardProps.category = 'GENERAL MANAGER';
          }
          if (idx === 4) {
            cardProps.name = 'Vanessa Nguyen';
            cardProps.category = 'CHIEF ASSISTANT';
          }

          // override images to use mem01…mem05
          const num = String(idx + 1).padStart(2, '0');  
          const cacheBust = '?v=1.1'; // Update version to force cache refresh
          
          // Special handling for Vanessa Nguyen (idx 4) - use same image for both
          if (idx === 4) {
            cardProps.image1 = `/images/mem05.webp${cacheBust}`;
            cardProps.image2 = `/images/mem05.webp${cacheBust}`;
          } else {
            cardProps.image1 = `/images/mem${num}.avif${cacheBust}`;
            cardProps.image2 = `/images/mem${num}-2.avif${cacheBust}`;
          }

          return (
            <div class={`project-card-link group${isWide ? ' card-wide' : ''} ${isWide ? 'order-1 md:order-none' : ''}`}>
              <div class={`overflow-hidden rounded-xl ${!isColor ? 'filter-green group-hover:filter-none transition-all duration-300' : ''}`}>
                <ProjectCard {...cardProps} />
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <style>
      /* Mobile: make cards full width */
      @media (max-width: 767px) {
        .project-card-link {
          max-width: 100% !important;
        }
      }

      .project-card-link {
        flex: 1 1 0;
        max-width: 350px;
        transition: flex-grow 0.3s ease, max-width 0.3s ease;
        min-width: 0;
      }

      @media (min-width: 768px) {
        /* Default wide card */
        .project-card-link.card-wide {
          flex-grow: 1.3;
          max-width: 450px;
        }

        /* Reset on container hover */
        .project-container:hover .project-card-link {
          flex-grow: 1;
          max-width: 350px;
        }

        .project-container:hover .project-card-link:hover {
          flex-grow: 1.3;
          max-width: 450px;
        }
      }

      @media (max-width: 767px) {
        .project-card-link.order-1 {
          order: -1;
        }
      }
    </style>
  </div>
</section>