---
import { getCollection } from "astro:content";
import ProjectCard from '../cards/ProjectCard.astro';

const categories = [
  { name: "All", key: "All" },
  { name: "Web", key: "Web" },
  { name: "Mobile", key: "Mobile" },
  { name: "Enterprise", key: "Enterprise" }
];

const lang = Astro.props?.lang || Astro.url.pathname.split('/')[1] || 'en';
const allProjects = (await getCollection("projects")).filter(p => p.id.endsWith(`.${lang}.md`));
const projects: Record<string, any[]> = {};
projects["All"] = allProjects.map(p => {
  const slug = p.id
    .replace(/^projects\//, '')
    .replace(/\.(en|vi|ja)\.md$/, '')
    .replace(/\.md$/, '');
  return {
    ...p.data,
    href: `/${lang}/projects/${slug}`
  };
});
for (const cat of categories) {
  if (cat.key !== "All") {
    projects[cat.key] = allProjects
      .filter(p => p.data.category === cat.key)
      .map(p => {
        const slug = p.id
          .replace(/^projects\//, '')
          .replace(/\.(en|vi|ja)\.md$/, '')
          .replace(/\.md$/, '');
        return {
          ...p.data,
          href: `/${lang}/projects/${slug}`
        };
      });
  }
}
---

<section class="py-16 px-4" style="background: var(--color-bg);">
  <div class="max-w-7xl mx-auto">
    <h2 class="text-4xl md:text-5xl font-bold text-center mb-8 font-lora" style="color: var(--color-black); font-family: 'Lora', serif;">
      PMU Training & Academy
    </h2>
    <p class="text-lg text-center mb-10 font-lora" style="color: var(--color-black); font-family: 'Lora', serif; max-width:700px; margin:0 auto;">
      At VyBrows Academy, permanent makeup is a blend of art and science, perfected to enhance natural beauty. Our highly trained team upholds the highest standards of hygiene and professionalism, ensuring comfort and safety in all our procedures.
    </p>

    <div class="w-full flex justify-center mt-6 px-3 md:mt-10 md:px-0">
      <div
        class="flex flex-col md:flex-row gap-[5px] project-container
               mx-0 md:mx-[30px]"
        style="max-width:1180px; width:100%;"
      >
        {projects["All"].slice(0, 4).map((proj, idx) => {
          const isWide = idx === 2; // card thứ 3 là card lớn
          const isColor = idx === 2; // card 3 có màu từ đầu
          // clone props so we can override images
          const cardProps = { ...proj };

          // override text
          if (idx === 0) {
            cardProps.name = 'Emily Bui';
            cardProps.category = 'GENERAL MANAGER / INSTRUCTOR';
          }
          if (idx === 1) {
            cardProps.name = 'Vy Nguyen';
            cardProps.category = 'CEO | FOUNDER / CONSTRUCTOR';
          }
          if (idx === 2) {
            cardProps.name = 'Kim Nguyen';
            cardProps.category = 'VICE PRESIDENT / CONSTRUCTOR';
          }
          if (idx === 3) {
            cardProps.name = 'Vanessa Nguyen';
            cardProps.category = 'CHIEF ASSISTANT';
          }

          // override images to use mem01…mem04
          const num = String(idx + 1).padStart(2, '0');  
          cardProps.image1 = `/images/mem${num}.avif`;
          cardProps.image2 = `/images/mem${num}-2.avif`;

          return (
            <div class={`project-card-link group${isWide ? ' card-wide' : ''} ${isWide ? 'order-1 md:order-none' : ''}`}>
              <div class={`overflow-hidden rounded-xl ${!isColor ? 'filter-green group-hover:filter-none transition-all duration-300' : ''}`}>
                <ProjectCard {...cardProps} />
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <style>
      /* Mobile: make cards full width */
      @media (max-width: 767px) {
        .project-card-link {
          max-width: 100% !important;
        }
      }

      .project-card-link {
        flex: 1 1 0;
        max-width: 350px;
        transition: flex-grow 0.3s ease, max-width 0.3s ease;
        min-width: 0;
      }

      @media (min-width: 768px) {
        /* Default wide card */
        .project-card-link.card-wide {
          flex-grow: 1.3;
          max-width: 450px;
        }

        /* Reset on container hover */
        .project-container:hover .project-card-link {
          flex-grow: 1;
          max-width: 350px;
        }

        .project-container:hover .project-card-link:hover {
          flex-grow: 1.3;
          max-width: 450px;
        }
      }

      @media (max-width: 767px) {
        .project-card-link.order-1 {
          order: -1;
        }
      }
    </style>
  </div>
</section>