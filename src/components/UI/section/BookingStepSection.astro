---
// BookingStepSection.astro - Modern booking component with accessibility and validation
import styles from './BookingStepSection.module.css';

// Configuration for steps and services
const STEPS = [
  { id: 1, title: 'Select Service', description: 'Choose your desired service and options' },
  { id: 2, title: 'Date & Time', description: 'Pick your preferred appointment time' },
  { id: 3, title: 'Personal Info', description: 'Provide your contact information' },
  { id: 4, title: 'Confirm', description: 'Review and confirm your booking' }
];

const SERVICE_CATEGORIES = [
  { 
    key: 'pmu', 
    title: 'PMU', 
    description: 'Permanent makeup services',
    groups: [
      {
        title: 'Brows',
        services: [
          { name: 'Shading Ombr√©', price: '$100', options: ['Classic', 'Ombre'] },
          { name: 'Micro Blading', price: '$120', options: ['Micro', 'Nano'] },
          { name: 'Combo Brows', price: '$150', options: ['Natural', 'Bold'] }
        ]
      },
      {
        title: 'Lips',
        services: [
          { name: 'Lip Blush', price: '$90', options: ['Soft', 'Bold'] }
        ]
      }
    ]
  },
  { 
    key: 'skincare', 
    title: 'Skincare',
    description: 'Professional facial treatments',
    groups: [
      {
        title: 'Facial Treatments',
        services: [
          { name: 'Acne Treatment', price: '$80', options: ['Basic', 'Advanced'] },
          { name: 'Hydra Facial', price: '$120', options: ['Hydrating', 'Brightening'] },
          { name: 'Chemical Peel', price: '$100', options: ['Light', 'Medium'] }
        ]
      }
    ]
  },
  { 
    key: 'detox', 
    title: 'Detox & Herbal Hair Wash',
    description: 'Natural hair and scalp treatments',
    groups: [
      {
        title: 'Hair Treatments',
        services: [
          { name: 'Herbal Hair Wash', price: '$60', options: ['Herbal', 'Premium'] },
          { name: 'Scalp Detox', price: '$80', options: ['Deep Clean', 'Scalp Massage'] }
        ]
      }
    ]
  }
];
---

<section 
  id="booking-step-section" 
  class="booking-step-section max-w-2xl mx-auto py-16 px-4 bg-white rounded-2xl shadow-lg"
  aria-label="Service booking form"
>
  <h2 class="text-3xl font-bold mb-8 text-center text-primary font-lora">
    Book VyBrows Beauty Services
  </h2>
  
  <div 
    id="booking-steps" 
    class={`${styles.bookingSteps} w-full relative overflow-hidden`} 
    style="min-height: 600px;"
    role="application"
    aria-label="Multi-step booking form"
  >
    
    <!-- Step Progress Indicators -->
    <nav 
      class="flex justify-between mb-8 relative z-20 px-4" 
      aria-label="Booking progress"
      role="progressbar"
      aria-valuemin="1"
      aria-valuemax="4"
      aria-valuenow="1"
      aria-valuetext="Step 1 of 4: Select Service"
    >
      {STEPS.map((step, index) => (
        <div 
          class={`${styles.stepIndicator} step-indicator ${index === 0 ? 'active' : ''}`}
          aria-current={index === 0 ? 'step' : undefined}
          aria-label={`Step ${step.id}: ${step.title}`}
          title={step.description}
        >
          <span class="sr-only">Step {step.id} of {STEPS.length}: </span>
          {step.id}. {step.title}
          <div class={styles.stepProgress} aria-hidden="true"></div>
        </div>
      ))}
    </nav>

    <!-- Steps Container -->
    <div 
      class={`${styles.stepsContainer} transitioning`} 
      id="steps-container"
      style={`--total-steps: ${STEPS.length};`}
    >
      
      <!-- Step 1: Service Selection -->
      <div 
        class={`${styles.step} step step-1`}
        role="tabpanel"
        aria-labelledby="step-1-title"
        tabindex="0"
      >
        <h3 id="step-1-title" class="text-xl font-bold mb-4 text-center text-primary">
          Select Your Service
        </h3>
        
        <!-- Category Selection -->
        <fieldset class="mb-6">
          <legend class="text-lg font-semibold mb-3 text-primary">
            Service Category
          </legend>
          
          <div 
            class="category-tabs flex gap-4 mb-6" 
            role="tablist" 
            aria-label="Service categories"
          >
            {SERVICE_CATEGORIES.map((category, index) => (
              <button 
                class={`${styles.tabBtn} tab-btn ${index === 0 ? 'active' : ''} px-4 py-2 rounded-lg font-bold`}
                role="tab"
                aria-selected={index === 0}
                aria-controls={`services-${category.key}`}
                data-tab={category.key}
                type="button"
                title={category.description}
              >
                {category.title}
              </button>
            ))}
          </div>
        </fieldset>
        
        <!-- Services Groups -->
        <fieldset>
          <legend class="text-lg font-semibold mb-3 text-primary">
            Available Services
          </legend>
          
          <div class="services-groups" aria-live="polite">
            {SERVICE_CATEGORIES.map((category) => (
              <div 
                class={`${styles.serviceGroup} service-group ${category.key !== 'pmu' ? 'hidden' : ''}`}
                data-group={category.key}
                id={`services-${category.key}`}
                role="tabpanel"
                aria-labelledby={`tab-${category.key}`}
              >
                {category.groups.map((group) => (
                  <div class="mb-6">
                    <h4 class="font-semibold mb-3 text-primary">{group.title}</h4>
                    <div class="service-list grid gap-2 md:grid-cols-2">
                      {group.services.map((service) => (
                        <button 
                          class={`${styles.serviceBtn} service-btn px-3 py-2 rounded text-left hover:shadow-md transition-all`}
                          data-service={service.name}
                          data-price={service.price}
                          data-options={JSON.stringify(service.options)}
                          type="button"
                          aria-describedby={`service-desc-${service.name.replace(/\s+/g, '-').toLowerCase()}`}
                        >
                          <div class="font-medium">{service.name}</div>
                          <div class="text-sm opacity-75">{service.price}</div>
                          <div 
                            id={`service-desc-${service.name.replace(/\s+/g, '-').toLowerCase()}`}
                            class="sr-only"
                          >
                            {service.name} service, price {service.price}, options: {service.options.join(', ')}
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </fieldset>
        
        <button 
          class={`${styles.nextBtn} next-btn px-6 py-2 rounded-lg font-bold mt-6`}
          type="button"
          aria-describedby="step-1-help"
        >
          Next: Select Date & Time
        </button>
        <div id="step-1-help" class="sr-only">
          Proceed to step 2 to select your preferred date and time
        </div>
        
        <!-- Service Options Modal -->
        <div 
          id="service-modal" 
          class={`${styles.serviceModal} fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50`} 
          style="display:none;"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-title"
          aria-describedby="modal-description"
        >
          <div class="bg-white rounded-xl p-6 min-w-[320px] max-w-md mx-4">
            <h4 id="modal-title" class="text-lg font-semibold mb-3 text-primary">
              Service Options
            </h4>
            <div id="modal-description" class="font-bold mb-4" id="modal-service-name"></div>
            
            <form id="modal-options-form" role="radiogroup" aria-labelledby="modal-title">
              <!-- Radio options will be dynamically rendered -->
            </form>
            
            <div class="flex gap-2 mt-4">
              <button 
                type="button" 
                class="close-modal px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors"
                aria-label="Close options dialog"
              >
                Cancel
              </button>
              <button 
                type="button" 
                class="select-option px-4 py-2 bg-primary text-white rounded hover:bg-primary-hover transition-colors"
                aria-label="Confirm selected option"
              >
                Select Option
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Step 2: Date & Time Selection -->
      <div 
        class={`${styles.step} step step-2`}
        role="tabpanel"
        aria-labelledby="step-2-title"
        tabindex="-1"
      >
        <h3 id="step-2-title" class="text-xl font-bold mb-4 text-center text-primary">
          Select Date & Time
        </h3>
        
        <form novalidate>
          <div class="mb-4">
            <label for="date" class="block mb-2 font-semibold text-primary">
              Select Date *
            </label>
            <input 
              type="date" 
              class={`${styles.fieldInput} field-input w-full px-3 py-2 rounded-lg`}
              id="date" 
              name="date"
              required
              aria-describedby="date-help date-error"
              min={new Date().toISOString().split('T')[0]}
            />
            <div id="date-help" class="text-sm text-gray-600 mt-1">
              Please select a future date for your appointment
            </div>
            <div id="date-error" class="error-message text-red-500 text-sm mt-1" style="display: none;" aria-live="polite"></div>
          </div>
          
          <div class="mb-6">
            <label for="time" class="block mb-2 font-semibold text-primary">
              Select Time *
            </label>
            <input 
              type="time" 
              class={`${styles.fieldInput} field-input w-full px-3 py-2 rounded-lg`}
              id="time" 
              name="time"
              required
              aria-describedby="time-help time-error"
              min="09:00"
              max="18:00"
              step="1800"
            />
            <div id="time-help" class="text-sm text-gray-600 mt-1">
              Business hours: 9:00 AM - 6:00 PM
            </div>
            <div id="time-error" class="error-message text-red-500 text-sm mt-1" style="display: none;" aria-live="polite"></div>
          </div>
        </form>
        
        <div class="flex gap-2 mt-6">
          <button 
            class={`${styles.prevBtn} prev-btn px-4 py-2 rounded-lg font-bold`}
            type="button"
            aria-label="Go back to service selection"
          >
            Back
          </button>
          <button 
            class={`${styles.nextBtn} next-btn px-6 py-2 rounded-lg font-bold`}
            type="button"
            aria-describedby="step-2-help"
          >
            Next: Personal Info
          </button>
        </div>
        <div id="step-2-help" class="sr-only">
          Proceed to step 3 to enter your personal information
        </div>
      </div>

      <!-- Step 3: Personal Information -->
      <div 
        class={`${styles.step} step step-3`}
        role="tabpanel"
        aria-labelledby="step-3-title"
        tabindex="-1"
      >
        <h3 id="step-3-title" class="text-xl font-bold mb-4 text-center text-primary">
          Personal Information
        </h3>
        
        <form novalidate>
          <div class="mb-4">
            <label for="name" class="block mb-2 font-semibold text-primary">
              Full Name *
            </label>
            <input 
              type="text" 
              class={`${styles.fieldInput} field-input w-full px-3 py-2 rounded-lg`}
              id="name" 
              name="name"
              placeholder="Enter your full name" 
              required
              minlength="2"
              maxlength="50"
              pattern="[A-Za-z\s]+"
              aria-describedby="name-help name-error"
              autocomplete="name"
            />
            <div id="name-help" class="text-sm text-gray-600 mt-1">
              Please enter your full name (letters only, 2-50 characters)
            </div>
            <div id="name-error" class="error-message text-red-500 text-sm mt-1" style="display: none;" aria-live="polite"></div>
          </div>
          
          <div class="mb-4">
            <label for="phone" class="block mb-2 font-semibold text-primary">
              Phone Number *
            </label>
            <input 
              type="tel" 
              class={`${styles.fieldInput} field-input w-full px-3 py-2 rounded-lg`}
              id="phone" 
              name="phone"
              placeholder="Enter your phone number" 
              required
              pattern="[0-9+\-\s()]+"
              minlength="10"
              maxlength="15"
              aria-describedby="phone-help phone-error"
              autocomplete="tel"
            />
            <div id="phone-help" class="text-sm text-gray-600 mt-1">
              Please enter a valid phone number (10-15 digits)
            </div>
            <div id="phone-error" class="error-message text-red-500 text-sm mt-1" style="display: none;" aria-live="polite"></div>
          </div>
          
          <div class="mb-6">
            <label for="email" class="block mb-2 font-semibold text-primary">
              Email Address *
            </label>
            <input 
              type="email" 
              class={`${styles.fieldInput} field-input w-full px-3 py-2 rounded-lg`}
              id="email" 
              name="email"
              placeholder="Enter your email address" 
              required
              aria-describedby="email-help email-error"
              autocomplete="email"
            />
            <div id="email-help" class="text-sm text-gray-600 mt-1">
              We'll use this to send you booking confirmation and updates
            </div>
            <div id="email-error" class="error-message text-red-500 text-sm mt-1" style="display: none;" aria-live="polite"></div>
          </div>
        </form>
        
        <div class="flex gap-2 mt-6">
          <button 
            class={`${styles.prevBtn} prev-btn px-4 py-2 rounded-lg font-bold`}
            type="button"
            aria-label="Go back to date and time selection"
          >
            Back
          </button>
          <button 
            class={`${styles.nextBtn} next-btn px-6 py-2 rounded-lg font-bold`}
            type="button"
            aria-describedby="step-3-help"
          >
            Next: Review Booking
          </button>
        </div>
        <div id="step-3-help" class="sr-only">
          Proceed to step 4 to review and confirm your booking
        </div>
      </div>

      <!-- Step 4: Confirmation -->
      <div 
        class={`${styles.step} step step-4`}
        role="tabpanel"
        aria-labelledby="step-4-title"
        tabindex="-1"
      >
        <h3 id="step-4-title" class="text-xl font-bold mb-4 text-center text-primary">
          Confirm Your Booking
        </h3>
        
        <div 
          class="mb-6" 
          id="confirm-info"
          aria-live="polite"
          aria-label="Booking summary"
        >
          <!-- Booking summary will be dynamically rendered -->
        </div>
        
        <div class="flex gap-2 mt-6">
          <button 
            class={`${styles.prevBtn} prev-btn px-4 py-2 rounded-lg font-bold`}
            type="button"
            aria-label="Go back to edit personal information"
          >
            Back
          </button>
          <button 
            class={`${styles.submitBtn} submit-btn px-6 py-2 rounded-lg font-bold`}
            type="button"
            aria-describedby="submit-help"
          >
            Confirm & Book
          </button>
        </div>
        <div id="submit-help" class="text-sm text-gray-600 mt-2">
          By confirming, you agree to our terms of service. We'll contact you within 24 hours to confirm your appointment.
        </div>
      </div>
      
    </div>
    
    <!-- Status Messages -->
    <div 
      id="booking-status" 
      class="mt-6 text-center font-semibold"
      aria-live="assertive"
      aria-atomic="true"
      role="status"
    ></div>
  </div>
</section>

<!-- Screen Reader Instructions -->
<div class="sr-only" id="screen-reader-instructions">
  <h2>Booking Form Instructions</h2>
  <p>This is a 4-step booking form. Use Tab to navigate between elements and Enter or Space to activate buttons. Form validation will provide feedback as you complete each field.</p>
</div>

<!-- Import the modern JavaScript module -->
<script is:inline src="/src/components/UI/section/BookingStepSectionModern.js"></script>
<style>
  /* Additional scoped styles for accessibility and validation */
  .booking-step-section {
    --primary-color: #01513A;
    --secondary-color: #e7d48e;
    --success-color: #10b981;
    --error-color: #ef4444;
    --gray-light: #f3f4f6;
    --gray-medium: #6b7280;
  }
  
  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  /* Focus management */
  .step:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 4px;
  }
  
  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .step-indicator {
      border: 2px solid currentColor;
    }
    
    .tab-btn, .service-btn, .field-input {
      border: 2px solid currentColor;
    }
  }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .steps-container,
    .step-indicator,
    .tab-btn,
    .service-btn,
    .next-btn,
    .prev-btn,
    .submit-btn,
    .field-input {
      transition: none;
    }
    
    .service-modal {
      animation: none;
    }
  }
  
  /* Form validation styles */
  .field-input:invalid:not(:focus) {
    border-color: var(--error-color);
  }
  
  .field-input:valid:not(:focus) {
    border-color: var(--success-color);
  }
  
  .field-input:required::after {
    content: " *";
    color: var(--error-color);
  }
  
  /* Loading state */
  .submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
  
  .submit-btn[aria-busy="true"]::after {
    content: "";
    width: 16px;
    height: 16px;
    margin-left: 8px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    display: inline-block;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Mobile accessibility improvements */
  @media (max-width: 768px) {
    .step-indicator {
      font-size: 0.875rem;
      padding: 6px 8px;
    }
    
    .tab-btn {
      font-size: 0.875rem;
      padding: 8px 12px;
    }
    
    .field-input {
      font-size: 16px; /* Prevents zoom on iOS */
    }
  }
</style>
</script>