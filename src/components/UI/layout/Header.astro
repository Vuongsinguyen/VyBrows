---
// Header.astro - Combined TopBar and Navbar
import Navbar from './Navbar.astro';

export interface Props { class?: string; currentLang?: string; }
const { class: customClass = '', currentLang: langProp } = Astro.props;

// Language mapping + detect current language
const langMap = { vi: 'Tiáº¿ng Viá»‡t', en: 'English', es: 'EspaÃ±ol', ja: 'æ—¥æœ¬èª', ko: 'í•œêµ­ì–´' } as const;
type Lang = keyof typeof langMap;

// Æ¯u tiÃªn prop currentLang, fallback theo URL
const rawLang = (langProp as Lang) || (Astro.url.pathname.split('/')[1] as Lang) || 'en';
const currentLang: Lang = (Object.keys(langMap) as Lang[]).includes(rawLang) ? rawLang : 'en';

const currentLangDisplay = langMap[currentLang] || langMap.en;

// Translation object
const t = {
  vi: { home: 'Trang chá»§', services: 'Dá»‹ch vá»¥', about: 'Vá» chÃºng tÃ´i', projects: 'Dá»± Ã¡n', news: 'Tin tá»©c', recruitment: 'Tuyá»ƒn dá»¥ng', contact: 'LiÃªn láº¡c' },
  en: { home: 'Home', services: 'Services', about: 'About Us', projects: 'Projects', news: 'News', recruitment: 'Recruitment', contact: 'Contact' },
  ja: { home: 'ãƒ›ãƒ¼ãƒ ', services: 'ã‚µãƒ¼ãƒ“ã‚¹', about: 'ç§ãŸã¡ã«ã¤ã„ã¦', projects: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', news: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', recruitment: 'æ¡ç”¨æƒ…å ±', contact: 'ãŠå•ã„åˆã‚ã›' },
  es: { home: 'Inicio', services: 'Servicios', about: 'Sobre nosotros', projects: 'Proyectos', news: 'Noticias', recruitment: 'Reclutamiento', contact: 'Contacto' },
  ko: { home: 'í™ˆ', services: 'ì„œë¹„ìŠ¤', about: 'íšŒì‚¬ ì†Œê°œ', projects: 'í”„ë¡œì íŠ¸', news: 'ë‰´ìŠ¤', recruitment: 'ì±„ìš©', contact: 'ë¬¸ì˜í•˜ê¸°' },
}[currentLang] ?? {};
---
<header
  id="header-container"
  class={`fixed top-0 left-0 right-0 z-[9999] ${customClass} border-b`}
  style="border-color: #01513A; z-index: 9999 !important;"
>
  <!-- Topbar Section -->
  <div id="topbar" class="text-white w-full block" style="background: var(--color-primary-gradient); display: block !important; height: 40px; overflow: visible; position: relative; z-index: 9999;">
    <div class="max-w-[1280px] mx-auto flex justify-between items-center px-6 py-0 text-sm font-medium" style="height: 40px; display: flex !important; overflow: visible; position: relative;">
      <!-- Contact Info -->
      <div class="flex items-center space-x-6">
        <a href="mailto:vybrowsk@gmail.com" class="items-center gap-1 hidden md:flex" style="color: var(--color-text); text-decoration: none;">
          <span class="material-icons-outlined text-base" style="font-size: 20px; color: var(--color-text);">mail</span>
          vybrowsk@gmail.com
        </a>
        <a href="tel:3464099999" class="items-center gap-1 hidden md:flex" style="color: var(--color-text); text-decoration: none;">
          <span class="material-icons-outlined text-base" style="font-size: 20px; color: var(--color-text);">call</span>
          US: (346)-409.9999
        </a>
        <a href="tel:+81333401053" class="items-center gap-1 hidden md:flex" style="color: var(--color-text); text-decoration: none;">
          <span class="material-icons-outlined text-base" style="font-size: 20px; color: var(--color-text);">call</span>
          US: (346)-409.8888
        </a>
        <!-- Mobile: only icons -->
        <a href={`/${currentLang}/contact`} class="md:hidden flex items-center" aria-label="Gá»­i email" style="color: var(--color-text);">
          <span class="material-icons-outlined text-base" style="font-size: 20px; color: inherit;">mail</span>
        </a>
        <a href="tel:+3464099999" class="md:hidden flex items-center" aria-label="Gá»i Ä‘iá»‡n thoáº¡i" style="color: var(--color-text);">
          <span class="material-icons-outlined text-base" style="font-size: 20px; color: inherit;">call</span>
        </a>
      </div>

      <!-- Right controls -->
      <div class="flex items-center gap-4" style="position: static; overflow: visible;">
        <a
          href="https://www.vytalityhealthbeauty.com/"
          class="hidden md:inline-block hover:underline text-sm font-medium"
          style="color: var(--color-text);"
        >
          Dr.ANMYTAS(US)
        </a>
  <a href="https://www.vytalityhealthbeauty.com/" class="hidden md:inline-block hover:underline text-sm font-medium" style="color: var(--color-text);">SUPPLY LIST</a>
  <a href="fb://page/vybrows" onclick="setTimeout(() => { window.location = 'https://www.facebook.com/vybrows'; }, 500);" class="hidden md:inline-block hover:underline text-sm font-medium" style="color: var(--color-text);">BLOG</a>

        <!-- Language Dropdown -->
        <div class="language-dropdown-container" style="position: relative; z-index: 10000 !important;" role="menu" aria-label="Language Switcher">
          <button
            id="lang-dropdown-btn"
            class="flex items-center gap-1 px-3 py-1.5 rounded border border-gray-300 hover:bg-white/10 transition-all cursor-pointer"
            type="button"
            aria-haspopup="true"
            aria-expanded="false"
            style="color: var(--color-text); border-color: var(--color-text); position: relative; z-index: 10001 !important;"
            onclick="console.log('ğŸ”¥ DIRECT CLICK WORKS!'); const menu = document.getElementById('lang-dropdown-menu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block';"
          >
            <span>{currentLangDisplay}</span>
            <svg class="w-4 h-4" fill="var(--color-text)" viewBox="0 0 24 24"><path d="M7 9.5L12 14.5L17 9.5H7Z"/></svg>
          </button>
          
          <!-- Dropdown Menu (child of container, sibling of button) -->
          <div id="lang-dropdown-menu" style="position: absolute; right: 0; top: calc(100% + 8px); display: none; min-width: 120px; z-index: 10002 !important;">
            <div style="background: rgba(0, 51, 36, 0.98) !important; border-radius: 6px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.1); min-width: 120px;">
              <div class="lang-switch" data-lang="vi" style="display: block; width: 100%; padding: 12px 16px; background: transparent; color: white; cursor: pointer; border-top-left-radius: 6px; border-top-right-radius: 6px; text-align: left; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">Tiáº¿ng Viá»‡t</div>
              <div class="lang-switch" data-lang="en" style="display: block; width: 100%; padding: 12px 16px; background: transparent; color: white; cursor: pointer; text-align: left; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">English</div>
              <div class="lang-switch" data-lang="ja" style="display: block; width: 100%; padding: 12px 16px; background: transparent; color: white; cursor: pointer; text-align: left; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">æ—¥æœ¬èª</div>
              <div class="lang-switch" data-lang="es" style="display: block; width: 100%; padding: 12px 16px; background: transparent; color: white; cursor: pointer; text-align: left; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">EspaÃ±ol</div>
              <div class="lang-switch" data-lang="ko" style="display: block; width: 100%; padding: 12px 16px; background: transparent; color: white; cursor: pointer; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; text-align: left; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">í•œêµ­ì–´</div>
            </div>
          </div>
        </div>

        <!-- Dark Mode Toggle -->
        <button id="toggle-dark" class="flex items-center gap-2 px-3 py-1 rounded hover:bg-white/10 dark:hover:bg-gray-800/30 transition-all" aria-label="Toggle dark mode">
          <svg id="sun-icon" class="w-5 h-5" fill="var(--color-white2white)" viewBox="0 0 24 24">
            <path d="M12 7a5 5 0 100 10 5 5 0 000-10zM2 13h2a1 1 0 100-2H2a1 1 0 100 2zm18 0h2a1 1 0 100-2h-2a1 1 0 100 2zM11 2v2a1 1 0 102 0V2a1 1 0 10-2 0zm0 18v2a1 1 0 102 0v-2a1 1 0 10-2 0zM5.99 4.58a1 1 0 00-1.41 1.41L5.64 7.05a1 1 0 101.41-1.41L5.99 4.58zm12.37 12.37a1 1 0 00-1.41 1.41l1.06 1.06a1 1 0 001.41-1.41l-1.06-1.06zM19.42 6.01a1 1 0 00-1.41-1.41l-1.06 1.06a1 1 0 101.41 1.41l1.06-1.06zM7.05 18.36a1 1 0 00-1.41 1.41l1.06 1.06a1 1 0 001.41-1.41l-1.06-1.06z"/>
          </svg>
          <svg id="moon-icon" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="none">
            <path d="M14.5 2C16.32 2 18.03 2.5 19.5 3.35C16.51 5.08 14.5 8.3 14.5 12C14.5 15.7 16.51 18.92 19.5 20.65C18.03 21.5 16.32 22 14.5 22C8.98 22 4.5 17.52 4.5 12C4.5 6.48 8.98 2 14.5 2Z" fill="var(--color-black2white)"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Import Navbar component -->
  <Navbar currentLang={currentLang} labels={t} />
</header>

<style>
  #header-container {
    transform: translateY(0);
    transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1); /* mÆ°á»£t hÆ¡n so vá»›i 0.3s ease */
    will-change: transform;
    backface-visibility: hidden;
    transform-style: preserve-3d;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 9999 !important;

    --hide-amount: 0px; /* sáº½ Ä‘Æ°á»£c JS cáº­p nháº­t */
  }
  #header-container.header-hidden {
    transform: translateY(calc(-1 * var(--hide-amount, 0px)));
  }

  @media (prefers-reduced-motion: reduce) {
    #header-container { transition-duration: 0.2s; }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.getElementById('header-container');
    if (!header) return;

    let lastScrollY = window.scrollY;
    let ticking = false;

    // NEW: visible height per breakpoint (desktop:55, mobile:65)
    function getVisible() {
      return window.matchMedia('(min-width: 768px)').matches ? 55 : 65;
    }

    function updateHideAmount() {
      const headerHeight = header.offsetHeight || 0;
      const visible = getVisible(); // 55 desktop, 65 mobile
      const hide = Math.max(headerHeight - visible, 0);
      header.style.setProperty('--hide-amount', hide + 'px');
    }

    updateHideAmount();

    function onScroll() {
      const currentY = window.scrollY;
      const threshold = getVisible();

      if (currentY === 0) {
        header.classList.remove('header-hidden');
      } else if (currentY > lastScrollY && currentY > threshold) {
        header.classList.add('header-hidden'); // áº©n chá»«a 55/65
      } else if (currentY < lastScrollY) {
        header.classList.remove('header-hidden');
      }

      lastScrollY = currentY;
      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(onScroll);
        ticking = true;
      }
    }, { passive: true });

    window.addEventListener('resize', () => {
      header.classList.remove('header-hidden');
      updateHideAmount(); // cáº­p nháº­t 55/65 khi Ä‘á»•i breakpoint
    });

    // Kiá»ƒm tra header cÃ³ tá»“n táº¡i
    console.log('Header script loaded, element:', header);
    
    // Äá»£i má»™t chÃºt Ä‘á»ƒ Ä‘áº£m báº£o DOM Ä‘Æ°á»£c render hoÃ n toÃ n
    setTimeout(() => {
      // Language dropdown functionality
      const langDropdownBtn = document.getElementById('lang-dropdown-btn');
      const langDropdownMenu = document.getElementById('lang-dropdown-menu');
      const langSwitchButtons = document.querySelectorAll('.lang-switch');
      
      console.log('ğŸ” DEBUG: Language elements found:', {
        button: langDropdownBtn,
        menu: langDropdownMenu,
        switches: langSwitchButtons.length,
        buttonExists: !!langDropdownBtn,
        menuExists: !!langDropdownMenu,
        buttonId: langDropdownBtn?.id,
        menuId: langDropdownMenu?.id
      });
      
      // Toggle dropdown menu
      if (langDropdownBtn && langDropdownMenu) {
        console.log('âœ… SETTING UP EVENT LISTENERS...');
        let isDropdownOpen = false;
        let clickTimeout;
        
        langDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸš¨ JAVASCRIPT CLICK TRIGGERED!');
          
          // Clear any pending timeout
          clearTimeout(clickTimeout);
          
          // Toggle state
          isDropdownOpen = !isDropdownOpen;
          langDropdownMenu.style.display = isDropdownOpen ? 'block' : 'none';
          langDropdownBtn.setAttribute('aria-expanded', isDropdownOpen.toString());
          console.log('Dropdown is now:', isDropdownOpen ? 'OPEN' : 'CLOSED');
        });
        
        console.log('âœ… CLICK LISTENER ADDED SUCCESSFULLY');
        
        // Close dropdown when clicking outside (with debounce)
        document.addEventListener('click', (e) => {
          clearTimeout(clickTimeout);
          clickTimeout = setTimeout(() => {
            if (!langDropdownBtn.contains(e.target) && !langDropdownMenu.contains(e.target) && isDropdownOpen) {
              langDropdownMenu.style.display = 'none';
              langDropdownBtn.setAttribute('aria-expanded', 'false');
              isDropdownOpen = false;
              console.log('Dropdown closed by outside click');
            }
          }, 10);
        });
      } else {
        console.error('Language dropdown elements not found:', {
          button: !!langDropdownBtn,
          menu: !!langDropdownMenu
        });
      }
      
      // Language switch functionality
      langSwitchButtons.forEach((button, index) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          const targetLang = button.getAttribute('data-lang');
          console.log(`Language button ${index + 1} clicked:`, targetLang);
          
          const currentPath = window.location.pathname;
          console.log('Current path:', currentPath);
          
          // Remove current language from path
          const pathWithoutLang = currentPath.replace(/^\/(vi|en|es|ja|ko)(\/|$)/, '/');
          console.log('Path without lang:', pathWithoutLang);
          
          // Build new URL with target language
          const newPath = targetLang === 'en' 
            ? pathWithoutLang === '/' ? '/' : pathWithoutLang
            : `/${targetLang}${pathWithoutLang === '/' ? '' : pathWithoutLang}`;
          
          console.log('New path will be:', newPath);
          
          // Navigate to new URL
          window.location.href = newPath;
        });
      });
    }, 100); // Äá»£i 100ms Ä‘á»ƒ DOM render xong
  });
</script>
