---
import '/src/styles/global.css';
import NewsLayout from '../layouts/NewsLayout.astro';
import NewsListComp from '../components/UI/layout/NewsListComp.astro';
import { getAllNews } from '../data/newsLoader.js';

export const prerender = true;

const lang = 'en'; // English version without prefix
const PAGE_SIZE = 25;
const pageParam = Astro.url?.searchParams.get('page');
const currentPage = pageParam ? parseInt(pageParam) : 1;

// Get news from JSON data for English
const allNews = getAllNews();
console.log('Total news articles:', allNews.length);
const news = allNews.map((item) => {
  const translation = item.translations.en; // Always English for this route
  return {
    id: item.id,
    title: translation.title,
    description: translation.shortDescription,
    image: item.mainImage,
    date: item.createdDate,
    category: 'PMU News', // Default category
    link: `/news/${item.id}`, // No /en/ prefix
  };
})
// Sort by date descending (newest first)
.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const totalNews = news.length;
const totalPages = Math.ceil(totalNews / PAGE_SIZE);
const pagedNews = news.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);
---

<NewsLayout title="News & Updates">
  <!-- Hero Header Section - Services Style -->
  <section class="relative bg-gradient-to-b from-[var(--color-primary-dark)] to-black pb-12 pt-60">
    <div class="max-w-[1280px] mx-auto px-4 relative z-10 flex flex-col items-center text-left pt-16">
      <!-- Dynamic Heading -->
      <h1 class="text-4xl md:text-5xl font-bold mb-8 text-white text-center" style="font-family: 'Playfair Display', serif;">News & Updates</h1>
      <p class="text-xl text-white/90 max-w-2xl mx-auto text-center mb-8">
        Stay updated with the latest news, trends, and insights from VyBrows Academy
      </p>
    </div>
    <!-- SVG Wave -->
    <div class="absolute inset-0 w-full h-full pointer-events-none select-none">
      <svg class="absolute bottom-0 left-0 w-full h-40" viewBox="0 0 1440 320" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill="var(--color-primary-dark)" fill-opacity="1" d="M0,288L80,272C160,256,320,224,480,197.3C640,171,800,149,960,154.7C1120,160,1280,192,1360,208L1440,224L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z"/>
      </svg>
    </div>
  </section>

  <!-- Breadcrumb -->
  <div class="bg-gray-100">
    <div class="max-w-7xl mx-auto px-6 py-3">
      <nav class="flex items-center text-sm text-gray-600">
        <a href="/" class="hover:text-[#8B4513] transition-colors">Home</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium">News</span>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <section class="py-16 px-6 min-h-screen" style="background: var(--color-bg);">
    <div class="max-w-7xl mx-auto">
      
      <!-- Toolbar -->
      <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div class="flex items-center gap-4">
          <h2 class="text-2xl font-bold text-gray-900">Latest Articles</h2>
          <span class="bg-[#8B4513] text-white px-3 py-1 rounded-full text-sm font-medium">
            {totalNews} articles
          </span>
        </div>
        
        <!-- View Toggle & Search -->
        <div class="flex items-center gap-4">
          <!-- Search Bar -->
          <div class="relative">
            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input 
              type="text" 
              placeholder="Search articles..." 
              class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#8B4513]/20 focus:border-[#8B4513] outline-none transition-colors w-64"
            />
          </div>
          
          <!-- View Mode Toggle -->
          <div class="flex items-center bg-white border border-gray-300 rounded-lg p-1">
            <button id="gridView" class="p-2 rounded text-gray-400 hover:text-[#8B4513] transition-colors view-toggle active" data-view="grid">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
            </button>
            <button id="listView" class="p-2 rounded text-gray-400 hover:text-[#8B4513] transition-colors view-toggle" data-view="list">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- News Content -->
      <div id="newsContainer">
        <NewsListComp news={pagedNews} viewMode="grid" />
      </div>

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex justify-center items-center mt-12 gap-2">
          <!-- Previous Button -->
          {currentPage > 1 && (
            <a 
              href={`/news?page=${currentPage - 1}`}
              class="flex items-center gap-1 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Previous
            </a>
          )}

          <!-- Page 1 -->
          <a 
            href="/news?page=1"
            class={currentPage === 1 
              ? 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[#8B4513] text-white' 
              : 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-white border border-gray-300 hover:bg-gray-50 text-gray-700'
            }
          >1</a>

          {totalPages > 1 && (
            <a 
              href="/news?page=2"
              class={currentPage === 2 
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[#8B4513] text-white' 
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-white border border-gray-300 hover:bg-gray-50 text-gray-700'
              }
            >2</a>
          )}

          {totalPages > 2 && (
            <a 
              href="/news?page=3"
              class={currentPage === 3 
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[#8B4513] text-white' 
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-white border border-gray-300 hover:bg-gray-50 text-gray-700'
              }
            >3</a>
          )}

          {totalPages > 4 && currentPage > 3 && <span class="px-2 text-gray-500">...</span>}

          {totalPages > 3 && currentPage > 3 && currentPage < totalPages && (
            <a 
              href={`/news?page=${currentPage}`}
              class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[#8B4513] text-white"
            >{currentPage}</a>
          )}

          {totalPages > 4 && currentPage < totalPages - 2 && <span class="px-2 text-gray-500">...</span>}

          {totalPages > 3 && (
            <a 
              href={`/news?page=${totalPages}`}
              class={currentPage === totalPages 
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[#8B4513] text-white' 
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-white border border-gray-300 hover:bg-gray-50 text-gray-700'
              }
            >{totalPages}</a>
          )}

          <!-- Next Button -->
          {currentPage < totalPages && (
            <a 
              href={`/news?page=${currentPage + 1}`}
              class="flex items-center gap-1 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"
            >
              Next
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          )}
        </div>
      )}
    </div>
  </section>

  <!-- JavaScript for View Toggle -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const viewToggles = document.querySelectorAll('.view-toggle');
      const newsContainer = document.getElementById('newsContainer');
      
      viewToggles.forEach(function(toggle) {
        toggle.addEventListener('click', function(event) {
          const target = event.currentTarget;
          
          // Remove active class from all toggles
          viewToggles.forEach(function(t) {
            t.classList.remove('active');
            t.classList.add('text-gray-400');
            t.classList.remove('text-[#8B4513]', 'bg-[#8B4513]/10');
          });
          
          // Add active class to clicked toggle
          target.classList.add('active');
          target.classList.remove('text-gray-400');
          target.classList.add('text-[#8B4513]', 'bg-[#8B4513]/10');
          
          // Here you would typically make an AJAX call to reload the news list with the new view mode
          // For now, we'll just show a visual feedback
          const viewMode = target.dataset.view;
          console.log('Switching to', viewMode, 'view');
        });
      });
    });
  </script>

  <style>
    .view-toggle.active {
      @apply text-[#8B4513] bg-[#8B4513]/10;
    }
  </style>
</NewsLayout>