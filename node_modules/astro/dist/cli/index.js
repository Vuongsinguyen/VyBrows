import * as colors from "kleur/colors";
import yargs from "yargs-parser";
import { ASTRO_VERSION } from "../core/constants.js";
async function printAstroHelp() {
  const { printHelp } = await import("../core/messages.js");
  printHelp({
    commandName: "astro",
    usage: "[command] [...flags]",
    headline: "Build faster websites.",
    tables: {
      Commands: [
        ["add", "Add an integration."],
        ["build", "Build your project and write it to disk."],
        ["check", "Check your project for errors."],
<<<<<<< HEAD
=======
        ["create-key", "Create a cryptography key"],
        ["db", "Manage your Astro database."],
>>>>>>> 08f40ceb (Initial)
        ["dev", "Start the development server."],
        ["docs", "Open documentation in your web browser."],
        ["info", "List info about your current Astro setup."],
        ["preview", "Preview your build locally."],
        ["sync", "Generate content collection types."],
<<<<<<< HEAD
        ["telemetry", "Configure telemetry settings."]
      ],
=======
        ["preferences", "Configure user preferences."],
        ["telemetry", "Configure telemetry settings."]
      ],
      "Studio Commands": [
        ["login", "Authenticate your machine with Astro Studio."],
        ["logout", "End your authenticated session with Astro Studio."],
        ["link", "Link this project directory to an Astro Studio project."]
      ],
>>>>>>> 08f40ceb (Initial)
      "Global Flags": [
        ["--config <path>", "Specify your config file."],
        ["--root <path>", "Specify your project root folder."],
        ["--site <url>", "Specify your project site."],
        ["--base <pathname>", "Specify your project base."],
        ["--verbose", "Enable verbose logging."],
        ["--silent", "Disable all logging."],
        ["--version", "Show the version number and exit."],
        ["--help", "Show this help message."]
      ]
    }
  });
}
function printVersion() {
  console.log();
  console.log(`  ${colors.bgGreen(colors.black(` astro `))} ${colors.green(`v${ASTRO_VERSION}`)}`);
}
function resolveCommand(flags) {
  const cmd = flags._[2];
<<<<<<< HEAD
  if (flags.version)
    return "version";
=======
  if (flags.version) return "version";
>>>>>>> 08f40ceb (Initial)
  const supportedCommands = /* @__PURE__ */ new Set([
    "add",
    "sync",
    "telemetry",
<<<<<<< HEAD
=======
    "preferences",
>>>>>>> 08f40ceb (Initial)
    "dev",
    "build",
    "preview",
    "check",
<<<<<<< HEAD
    "docs",
    "info"
=======
    "create-key",
    "docs",
    "db",
    "info",
    "login",
    "logout",
    "link",
    "init"
>>>>>>> 08f40ceb (Initial)
  ]);
  if (supportedCommands.has(cmd)) {
    return cmd;
  }
  return "help";
}
async function runCommand(cmd, flags) {
<<<<<<< HEAD
  var _a;
=======
>>>>>>> 08f40ceb (Initial)
  switch (cmd) {
    case "help":
      await printAstroHelp();
      return;
    case "version":
      printVersion();
      return;
    case "info": {
      const { printInfo } = await import("./info/index.js");
      await printInfo({ flags });
      return;
    }
<<<<<<< HEAD
=======
    case "create-key": {
      const { createKey } = await import("./create-key/index.js");
      const exitCode = await createKey({ flags });
      return process.exit(exitCode);
    }
>>>>>>> 08f40ceb (Initial)
    case "docs": {
      const { docs } = await import("./docs/index.js");
      await docs({ flags });
      return;
    }
    case "telemetry": {
      const { update } = await import("./telemetry/index.js");
<<<<<<< HEAD
      const subcommand = (_a = flags._[3]) == null ? void 0 : _a.toString();
      await update(subcommand, { flags });
      return;
    }
=======
      const subcommand = flags._[3]?.toString();
      await update(subcommand, { flags });
      return;
    }
    case "sync": {
      const { sync } = await import("./sync/index.js");
      await sync({ flags });
      return;
    }
    case "preferences": {
      const { preferences } = await import("./preferences/index.js");
      const [subcommand, key, value] = flags._.slice(3).map((v) => v.toString());
      const exitCode = await preferences(subcommand, key, value, { flags });
      return process.exit(exitCode);
    }
>>>>>>> 08f40ceb (Initial)
  }
  if (flags.verbose) {
    const { enableVerboseLogging } = await import("../core/logger/node.js");
    enableVerboseLogging();
  }
<<<<<<< HEAD
  if (!process.env.NODE_ENV) {
    process.env.NODE_ENV = cmd === "dev" ? "development" : "production";
  }
=======
  const { notify } = await import("./telemetry/index.js");
  await notify();
>>>>>>> 08f40ceb (Initial)
  switch (cmd) {
    case "add": {
      const { add } = await import("./add/index.js");
      const packages = flags._.slice(3);
      await add(packages, { flags });
      return;
    }
<<<<<<< HEAD
=======
    case "db":
    case "login":
    case "logout":
    case "link":
    case "init": {
      const { db } = await import("./db/index.js");
      await db({ flags });
      return;
    }
>>>>>>> 08f40ceb (Initial)
    case "dev": {
      const { dev } = await import("./dev/index.js");
      const server = await dev({ flags });
      if (server) {
        return await new Promise(() => {
        });
      }
      return;
    }
    case "build": {
      const { build } = await import("./build/index.js");
      await build({ flags });
      return;
    }
    case "preview": {
      const { preview } = await import("./preview/index.js");
      const server = await preview({ flags });
      if (server) {
        return await server.closed();
      }
      return;
    }
    case "check": {
      const { check } = await import("./check/index.js");
<<<<<<< HEAD
      const checkServer = await check({ flags });
      if (checkServer) {
        if (checkServer.isWatchMode) {
          await checkServer.watch();
          return await new Promise(() => {
          });
        } else {
          const checkResult = await checkServer.check();
          return process.exit(checkResult);
        }
      }
      return;
    }
    case "sync": {
      const { sync } = await import("./sync/index.js");
      const exitCode = await sync({ flags });
      return process.exit(exitCode);
=======
      const checkServer = await check(flags);
      if (flags.watch) {
        return await new Promise(() => {
        });
      } else {
        return process.exit(checkServer ? 1 : 0);
      }
>>>>>>> 08f40ceb (Initial)
    }
  }
  throw new Error(`Error running ${cmd} -- no command found.`);
}
<<<<<<< HEAD
async function cli(args) {
  const flags = yargs(args);
=======
async function cli(argv) {
  const flags = yargs(argv, { boolean: ["global"], alias: { g: "global" } });
>>>>>>> 08f40ceb (Initial)
  const cmd = resolveCommand(flags);
  try {
    await runCommand(cmd, flags);
  } catch (err) {
    const { throwAndExit } = await import("./throw-and-exit.js");
    await throwAndExit(cmd, err);
  }
}
export {
  cli
};
