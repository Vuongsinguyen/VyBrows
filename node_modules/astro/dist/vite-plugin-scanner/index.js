<<<<<<< HEAD
import { bold } from "kleur/colors";
import { extname } from "node:path";
import { normalizePath } from "vite";
import { warn } from "../core/logger/core.js";
import { isEndpoint, isPage, rootRelativePath } from "../core/util.js";
import { getPrerenderDefault, isServerLikeOutput } from "../prerender/utils.js";
import { scan } from "./scan.js";
const KNOWN_FILE_EXTENSIONS = [".astro", ".js", ".ts"];
function astroScannerPlugin({
  settings,
  logging
=======
import { extname } from "node:path";
import { fileURLToPath } from "node:url";
import { bold } from "kleur/colors";
import { warnMissingAdapter } from "../core/dev/adapter-validation.js";
import { getRoutePrerenderOption } from "../core/routing/manifest/prerender.js";
import { isEndpoint, isPage } from "../core/util.js";
import { normalizePath, rootRelativePath } from "../core/viteUtils.js";
import { createDefaultAstroMetadata } from "../vite-plugin-astro/metadata.js";
const KNOWN_FILE_EXTENSIONS = [".astro", ".js", ".ts"];
function astroScannerPlugin({
  settings,
  logger,
  routesList
>>>>>>> 08f40ceb (Initial)
}) {
  return {
    name: "astro:scanner",
    enforce: "post",
    async transform(code, id, options) {
<<<<<<< HEAD
      if (!(options == null ? void 0 : options.ssr))
        return;
=======
      if (!options?.ssr) return;
>>>>>>> 08f40ceb (Initial)
      const filename = normalizePath(id);
      let fileURL;
      try {
        fileURL = new URL(`file://${filename}`);
<<<<<<< HEAD
      } catch (e) {
=======
      } catch {
>>>>>>> 08f40ceb (Initial)
        return;
      }
      const fileIsPage = isPage(fileURL, settings);
      const fileIsEndpoint = isEndpoint(fileURL, settings);
<<<<<<< HEAD
      if (!(fileIsPage || fileIsEndpoint))
        return;
      const defaultPrerender = getPrerenderDefault(settings.config);
      const pageOptions = await scan(code, id, settings);
      if (typeof pageOptions.prerender === "undefined") {
        pageOptions.prerender = defaultPrerender;
      }
      if (!pageOptions.prerender && isServerLikeOutput(settings.config) && code.includes("getStaticPaths") && // this should only be valid for `.astro`, `.js` and `.ts` files
      KNOWN_FILE_EXTENSIONS.includes(extname(filename))) {
        const reason = ` because \`output: "${settings.config.output}"\` is set`;
        warn(
          logging,
          "getStaticPaths",
          `The getStaticPaths() statement in ${bold(
            rootRelativePath(settings.config.root, fileURL, true)
          )} has been ignored${reason}.

Add \`export const prerender = true;\` to prerender this page.`
=======
      if (!(fileIsPage || fileIsEndpoint)) return;
      const route = routesList.routes.find((r) => {
        const filePath = new URL(`./${r.component}`, settings.config.root);
        return normalizePath(fileURLToPath(filePath)) === filename;
      });
      if (!route) {
        return;
      }
      if (!route.prerender && code.includes("getStaticPaths") && // this should only be valid for `.astro`, `.js` and `.ts` files
      KNOWN_FILE_EXTENSIONS.includes(extname(filename))) {
        logger.warn(
          "router",
          `getStaticPaths() ignored in dynamic page ${bold(
            rootRelativePath(settings.config.root, fileURL, true)
          )}. Add \`export const prerender = true;\` to prerender the page as static HTML during the build process.`
>>>>>>> 08f40ceb (Initial)
        );
      }
      const { meta = {} } = this.getModuleInfo(id) ?? {};
      return {
        code,
        map: null,
        meta: {
          ...meta,
          astro: {
<<<<<<< HEAD
            ...meta.astro ?? { hydratedComponents: [], clientOnlyComponents: [], scripts: [] },
            pageOptions
          }
        }
      };
=======
            ...meta.astro ?? createDefaultAstroMetadata(),
            pageOptions: {
              prerender: route.prerender
            }
          }
        }
      };
    },
    // Handle hot updates to update the prerender option
    async handleHotUpdate(ctx) {
      const filename = normalizePath(ctx.file);
      let fileURL;
      try {
        fileURL = new URL(`file://${filename}`);
      } catch {
        return;
      }
      const fileIsPage = isPage(fileURL, settings);
      const fileIsEndpoint = isEndpoint(fileURL, settings);
      if (!(fileIsPage || fileIsEndpoint)) return;
      const route = routesList.routes.find((r) => {
        const filePath = new URL(`./${r.component}`, settings.config.root);
        return normalizePath(fileURLToPath(filePath)) === filename;
      });
      if (!route) {
        return;
      }
      await getRoutePrerenderOption(await ctx.read(), route, settings, logger);
      warnMissingAdapter(logger, settings);
>>>>>>> 08f40ceb (Initial)
    }
  };
}
export {
  astroScannerPlugin as default
};
