<<<<<<< HEAD
import { getTopLevelPages, walkParentInfos } from "../core/build/graph.js";
import { getAstroMetadata } from "../vite-plugin-astro/index.js";
const injectExp = /(^\/\/|\/\/!)\s*astro-head-inject/;
function configHeadVitePlugin() {
  let server;
  function propagateMetadata(id, prop, value, seen = /* @__PURE__ */ new Set()) {
    if (seen.has(id))
      return;
    seen.add(id);
    const mod = server.moduleGraph.getModuleById(id);
    const info = this.getModuleInfo(id);
    if (info == null ? void 0 : info.meta.astro) {
=======
import { getParentModuleInfos, getTopLevelPageModuleInfos } from "../core/build/graph.js";
import { getAstroMetadata } from "../vite-plugin-astro/index.js";
const injectExp = /(?:^\/\/|\/\/!)\s*astro-head-inject/;
function configHeadVitePlugin() {
  let server;
  function propagateMetadata(id, prop, value, seen = /* @__PURE__ */ new Set()) {
    if (seen.has(id)) return;
    seen.add(id);
    const mod = server.moduleGraph.getModuleById(id);
    const info = this.getModuleInfo(id);
    if (info?.meta.astro) {
>>>>>>> 08f40ceb (Initial)
      const astroMetadata = getAstroMetadata(info);
      if (astroMetadata) {
        Reflect.set(astroMetadata, prop, value);
      }
    }
<<<<<<< HEAD
    for (const parent of (mod == null ? void 0 : mod.importers) || []) {
=======
    for (const parent of mod?.importers || []) {
>>>>>>> 08f40ceb (Initial)
      if (parent.id) {
        propagateMetadata.call(this, parent.id, prop, value, seen);
      }
    }
  }
  return {
    name: "astro:head-metadata",
<<<<<<< HEAD
    configureServer(_server) {
      server = _server;
    },
    transform(source, id) {
      var _a;
=======
    enforce: "pre",
    apply: "serve",
    configureServer(_server) {
      server = _server;
    },
    resolveId(source, importer) {
      if (importer) {
        return this.resolve(source, importer, { skipSelf: true }).then((result) => {
          if (result) {
            let info = this.getModuleInfo(result.id);
            const astro = info && getAstroMetadata(info);
            if (astro) {
              if (astro.propagation === "self" || astro.propagation === "in-tree") {
                propagateMetadata.call(this, importer, "propagation", "in-tree");
              }
              if (astro.containsHead) {
                propagateMetadata.call(this, importer, "containsHead", true);
              }
            }
          }
          return result;
        });
      }
    },
    transform(source, id) {
>>>>>>> 08f40ceb (Initial)
      if (!server) {
        return;
      }
      let info = this.getModuleInfo(id);
<<<<<<< HEAD
      if (info && ((_a = getAstroMetadata(info)) == null ? void 0 : _a.containsHead)) {
        propagateMetadata.call(this, id, "containsHead", true);
      }
=======
      if (info && getAstroMetadata(info)?.containsHead) {
        propagateMetadata.call(this, id, "containsHead", true);
      }
      if (info && getAstroMetadata(info)?.propagation === "self") {
        const mod = server.moduleGraph.getModuleById(id);
        for (const parent of mod?.importers ?? []) {
          if (parent.id) {
            propagateMetadata.call(this, parent.id, "propagation", "in-tree");
          }
        }
      }
>>>>>>> 08f40ceb (Initial)
      if (injectExp.test(source)) {
        propagateMetadata.call(this, id, "propagation", "in-tree");
      }
    }
  };
}
function astroHeadBuildPlugin(internals) {
  return {
<<<<<<< HEAD
    build: "ssr",
=======
    targets: ["server"],
>>>>>>> 08f40ceb (Initial)
    hooks: {
      "build:before"() {
        return {
          vitePlugin: {
            name: "astro:head-metadata-build",
            generateBundle(_opts, bundle) {
<<<<<<< HEAD
              var _a;
              const map = internals.componentMetadata;
              function getOrCreateMetadata(id) {
                if (map.has(id))
                  return map.get(id);
=======
              const map = internals.componentMetadata;
              function getOrCreateMetadata(id) {
                if (map.has(id)) return map.get(id);
>>>>>>> 08f40ceb (Initial)
                const metadata = {
                  propagation: "none",
                  containsHead: false
                };
                map.set(id, metadata);
                return metadata;
              }
              for (const [, output] of Object.entries(bundle)) {
<<<<<<< HEAD
                if (output.type !== "chunk")
                  continue;
                for (const [id, mod] of Object.entries(output.modules)) {
                  const modinfo = this.getModuleInfo(id);
                  if (modinfo && ((_a = getAstroMetadata(modinfo)) == null ? void 0 : _a.containsHead)) {
                    for (const [pageInfo] of getTopLevelPages(id, this)) {
                      let metadata = getOrCreateMetadata(pageInfo.id);
                      metadata.containsHead = true;
                    }
                  }
                  if (mod.code && injectExp.test(mod.code)) {
                    for (const [info] of walkParentInfos(id, this)) {
=======
                if (output.type !== "chunk") continue;
                for (const [id, mod] of Object.entries(output.modules)) {
                  const modinfo = this.getModuleInfo(id);
                  if (modinfo) {
                    const meta = getAstroMetadata(modinfo);
                    if (meta?.containsHead) {
                      for (const pageInfo of getTopLevelPageModuleInfos(id, this)) {
                        let metadata = getOrCreateMetadata(pageInfo.id);
                        metadata.containsHead = true;
                      }
                    }
                    if (meta?.propagation === "self") {
                      for (const info of getParentModuleInfos(id, this)) {
                        let metadata = getOrCreateMetadata(info.id);
                        if (metadata.propagation !== "self") {
                          metadata.propagation = "in-tree";
                        }
                      }
                    }
                  }
                  if (mod.code && injectExp.test(mod.code)) {
                    for (const info of getParentModuleInfos(id, this)) {
>>>>>>> 08f40ceb (Initial)
                      getOrCreateMetadata(info.id).propagation = "in-tree";
                    }
                  }
                }
              }
            }
          }
        };
      }
    }
  };
}
export {
  astroHeadBuildPlugin,
  configHeadVitePlugin as default
};
