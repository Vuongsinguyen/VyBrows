import * as fs from "node:fs";
import { fileURLToPath } from "node:url";
<<<<<<< HEAD
import { getHighlighter } from "shiki";
import { FailedToLoadModuleSSR, InvalidGlob, MdxIntegrationMissingError } from "../errors-data.js";
import { AstroError } from "../errors.js";
import { createSafeError } from "../utils.js";
import { renderErrorMarkdown } from "./utils.js";
=======
import { codeToHtml, createCssVariablesTheme } from "shiki";
import { AstroError } from "../errors.js";
import { FailedToLoadModuleSSR, InvalidGlob, MdxIntegrationMissingError } from "../errors-data.js";
import { createSafeError } from "../utils.js";
import { getDocsForError, renderErrorMarkdown } from "./utils.js";
>>>>>>> 08f40ceb (Initial)
function enhanceViteSSRError({
  error,
  filePath,
  loader,
  renderers
}) {
<<<<<<< HEAD
  var _a, _b, _c, _d, _e;
=======
>>>>>>> 08f40ceb (Initial)
  let safeError = createSafeError(error);
  if (loader) {
    try {
      loader.fixStacktrace(safeError);
    } catch {
    }
  }
  if (filePath) {
    const path = fileURLToPath(filePath);
    const content = fs.readFileSync(path).toString();
    const lns = content.split("\n");
    let importName;
<<<<<<< HEAD
    if (importName = (_a = safeError.message.match(/Failed to load url (.*?) \(resolved id:/)) == null ? void 0 : _a[1]) {
=======
    if (importName = /Failed to load url (.*?) \(resolved id:/.exec(safeError.message)?.[1]) {
>>>>>>> 08f40ceb (Initial)
      safeError.title = FailedToLoadModuleSSR.title;
      safeError.name = "FailedToLoadModuleSSR";
      safeError.message = FailedToLoadModuleSSR.message(importName);
      safeError.hint = FailedToLoadModuleSSR.hint;
      const line = lns.findIndex((ln) => ln.includes(importName));
      if (line !== -1) {
<<<<<<< HEAD
        const column = (_b = lns[line]) == null ? void 0 : _b.indexOf(importName);
=======
        const column = lns[line]?.indexOf(importName);
>>>>>>> 08f40ceb (Initial)
        safeError.loc = {
          file: path,
          line: line + 1,
          column
        };
      }
    }
<<<<<<< HEAD
    const fileId = safeError.id ?? ((_c = safeError.loc) == null ? void 0 : _c.file);
    if (!(renderers == null ? void 0 : renderers.find((r) => r.name === "@astrojs/mdx")) && safeError.message.match(/Syntax error/) && (fileId == null ? void 0 : fileId.match(/\.mdx$/))) {
=======
    const fileId = safeError.id ?? safeError.loc?.file;
    if (fileId && !renderers?.find((r) => r.name === "@astrojs/mdx") && safeError.message.includes("Syntax error") && /.mdx$/.test(fileId)) {
>>>>>>> 08f40ceb (Initial)
      safeError = new AstroError({
        ...MdxIntegrationMissingError,
        message: MdxIntegrationMissingError.message(JSON.stringify(fileId)),
        location: safeError.loc,
        stack: safeError.stack
      });
    }
<<<<<<< HEAD
    if (/Invalid glob/.test(safeError.message)) {
      const globPattern = (_d = safeError.message.match(/glob: "(.+)" \(/)) == null ? void 0 : _d[1];
      if (globPattern) {
        safeError.message = InvalidGlob.message(globPattern);
        safeError.name = "InvalidGlob";
        safeError.hint = InvalidGlob.hint;
        safeError.title = InvalidGlob.title;
        const line = lns.findIndex((ln) => ln.includes(globPattern));
        if (line !== -1) {
          const column = (_e = lns[line]) == null ? void 0 : _e.indexOf(globPattern);
=======
    if (safeError.message.includes("Invalid glob")) {
      const globPattern = /glob: "(.+)" \(/.exec(safeError.message)?.[1];
      if (globPattern) {
        safeError.message = InvalidGlob.message(globPattern);
        safeError.name = "InvalidGlob";
        safeError.title = InvalidGlob.title;
        const line = lns.findIndex((ln) => ln.includes(globPattern));
        if (line !== -1) {
          const column = lns[line]?.indexOf(globPattern);
>>>>>>> 08f40ceb (Initial)
          safeError.loc = {
            file: path,
            line: line + 1,
            column
          };
        }
      }
    }
  }
  return safeError;
}
const ALTERNATIVE_JS_EXTS = ["cjs", "mjs"];
const ALTERNATIVE_MD_EXTS = ["mdoc"];
<<<<<<< HEAD
async function getViteErrorPayload(err) {
  var _a, _b, _c, _d, _e, _f;
=======
let _cssVariablesTheme;
const cssVariablesTheme = () => _cssVariablesTheme ?? (_cssVariablesTheme = createCssVariablesTheme({ variablePrefix: "--astro-code-" }));
async function getViteErrorPayload(err) {
>>>>>>> 08f40ceb (Initial)
  let plugin = err.plugin;
  if (!plugin && err.hint) {
    plugin = "astro";
  }
  const message = renderErrorMarkdown(err.message.trim(), "html");
  const hint = err.hint ? renderErrorMarkdown(err.hint.trim(), "html") : void 0;
<<<<<<< HEAD
  const hasDocs = !!err.name;
  const docslink = hasDocs ? `https://docs.astro.build/en/reference/errors/${getKebabErrorName(err.name)}/` : void 0;
  const highlighter = await getHighlighter({ theme: "css-variables" });
  let highlighterLang = (_b = (_a = err.loc) == null ? void 0 : _a.file) == null ? void 0 : _b.split(".").pop();
  if (ALTERNATIVE_JS_EXTS.includes(highlighterLang ?? "")) {
    highlighterLang = "js";
  }
  if (ALTERNATIVE_MD_EXTS.includes(highlighterLang ?? "")) {
    highlighterLang = "md";
  }
  const highlightedCode = err.fullCode ? highlighter.codeToHtml(err.fullCode, {
    lang: highlighterLang,
    lineOptions: ((_c = err.loc) == null ? void 0 : _c.line) ? [{ line: err.loc.line, classes: ["error-line"] }] : void 0
  }) : void 0;
  return {
=======
  const docslink = getDocsForError(err);
  let highlighterLang = err.loc?.file?.split(".").pop();
  if (ALTERNATIVE_JS_EXTS.includes(highlighterLang ?? "")) {
    highlighterLang = "js";
  } else if (ALTERNATIVE_MD_EXTS.includes(highlighterLang ?? "")) {
    highlighterLang = "md";
  }
  const highlightedCode = err.fullCode ? await codeToHtml(err.fullCode, {
    lang: highlighterLang ?? "text",
    theme: cssVariablesTheme(),
    transformers: [
      transformerCompactLineOptions(
        err.loc?.line ? [{ line: err.loc.line, classes: ["error-line"] }] : void 0
      )
    ]
  }) : void 0;
  return {
    __isEnhancedAstroErrorPayload: true,
>>>>>>> 08f40ceb (Initial)
    type: "error",
    err: {
      ...err,
      name: err.name,
      type: err.type,
      message,
      hint,
      frame: err.frame,
      highlightedCode,
      docslink,
      loc: {
<<<<<<< HEAD
        file: (_d = err.loc) == null ? void 0 : _d.file,
        line: (_e = err.loc) == null ? void 0 : _e.line,
        column: (_f = err.loc) == null ? void 0 : _f.column
=======
        file: err.loc?.file,
        line: err.loc?.line,
        column: err.loc?.column
>>>>>>> 08f40ceb (Initial)
      },
      plugin,
      stack: err.stack,
      cause: err.cause
    }
  };
<<<<<<< HEAD
  function getKebabErrorName(errorName) {
    return errorName.replace(/([a-z])([A-Z])/g, "$1-$2").toLowerCase();
  }
=======
}
function transformerCompactLineOptions(lineOptions = []) {
  return {
    name: "@shikijs/transformers:compact-line-options",
    line(node, line) {
      const lineOption = lineOptions.find((o) => o.line === line);
      if (lineOption?.classes) this.addClassToHast(node, lineOption.classes);
      return node;
    }
  };
>>>>>>> 08f40ceb (Initial)
}
export {
  enhanceViteSSRError,
  getViteErrorPayload
};
