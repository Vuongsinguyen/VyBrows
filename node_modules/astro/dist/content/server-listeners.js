<<<<<<< HEAD
import { bold, cyan } from "kleur/colors";
import path from "node:path";
import { fileURLToPath, pathToFileURL } from "node:url";
import { loadTSConfig } from "../core/config/tsconfig.js";
import { info, warn } from "../core/logger/core.js";
=======
import path from "node:path";
import { fileURLToPath, pathToFileURL } from "node:url";
import { bold, cyan, underline } from "kleur/colors";
import { loadTSConfig } from "../core/config/tsconfig.js";
>>>>>>> 08f40ceb (Initial)
import { appendForwardSlash } from "../core/path.js";
import { createContentTypesGenerator } from "./types-generator.js";
import { getContentPaths, globalContentConfigObserver } from "./utils.js";
async function attachContentServerListeners({
  viteServer,
  fs,
<<<<<<< HEAD
  logging,
  settings
}) {
  const contentPaths = getContentPaths(settings.config, fs);
  if (fs.existsSync(contentPaths.contentDir)) {
    info(
      logging,
=======
  logger,
  settings
}) {
  const contentPaths = getContentPaths(settings.config, fs);
  if (!settings.config.legacy?.collections) {
    await attachListeners();
  } else if (fs.existsSync(contentPaths.contentDir)) {
    logger.debug(
>>>>>>> 08f40ceb (Initial)
      "content",
      `Watching ${cyan(
        contentPaths.contentDir.href.replace(settings.config.root.href, "")
      )} for changes`
    );
<<<<<<< HEAD
    const maybeTsConfigStats = getTSConfigStatsWhenAllowJsFalse({ contentPaths, settings });
    if (maybeTsConfigStats)
      warnAllowJsIsFalse({ ...maybeTsConfigStats, logging });
=======
    const maybeTsConfigStats = await getTSConfigStatsWhenAllowJsFalse({ contentPaths, settings });
    if (maybeTsConfigStats) warnAllowJsIsFalse({ ...maybeTsConfigStats, logger });
>>>>>>> 08f40ceb (Initial)
    await attachListeners();
  } else {
    viteServer.watcher.on("addDir", contentDirListener);
    async function contentDirListener(dir) {
      if (appendForwardSlash(pathToFileURL(dir).href) === contentPaths.contentDir.href) {
<<<<<<< HEAD
        info(logging, "content", `Content dir found. Watching for changes`);
=======
        logger.debug("content", `Content directory found. Watching for changes`);
>>>>>>> 08f40ceb (Initial)
        await attachListeners();
        viteServer.watcher.removeListener("addDir", contentDirListener);
      }
    }
  }
  async function attachListeners() {
    const contentGenerator = await createContentTypesGenerator({
      fs,
      settings,
<<<<<<< HEAD
      logging,
=======
      logger,
>>>>>>> 08f40ceb (Initial)
      viteServer,
      contentConfigObserver: globalContentConfigObserver
    });
    await contentGenerator.init();
<<<<<<< HEAD
    info(logging, "content", "Types generated");
=======
    logger.debug("content", "Types generated");
>>>>>>> 08f40ceb (Initial)
    viteServer.watcher.on("add", (entry) => {
      contentGenerator.queueEvent({ name: "add", entry });
    });
    viteServer.watcher.on(
      "addDir",
      (entry) => contentGenerator.queueEvent({ name: "addDir", entry })
    );
<<<<<<< HEAD
    viteServer.watcher.on(
      "change",
      (entry) => contentGenerator.queueEvent({ name: "change", entry })
    );
=======
    viteServer.watcher.on("change", (entry) => {
      contentGenerator.queueEvent({ name: "change", entry });
    });
>>>>>>> 08f40ceb (Initial)
    viteServer.watcher.on("unlink", (entry) => {
      contentGenerator.queueEvent({ name: "unlink", entry });
    });
    viteServer.watcher.on(
      "unlinkDir",
      (entry) => contentGenerator.queueEvent({ name: "unlinkDir", entry })
    );
  }
}
function warnAllowJsIsFalse({
<<<<<<< HEAD
  logging,
  tsConfigFileName,
  contentConfigFileName
}) {
  if (!["info", "warn"].includes(logging.level))
    warn(
      logging,
      "content",
      `Make sure you have the ${bold("allowJs")} compiler option set to ${bold(
        "true"
      )} in your ${bold(tsConfigFileName)} file to have autocompletion in your ${bold(
        contentConfigFileName
      )} file.
See ${bold("https://www.typescriptlang.org/tsconfig#allowJs")} for more information.
			`
    );
}
function getTSConfigStatsWhenAllowJsFalse({
  contentPaths,
  settings
}) {
  var _a, _b;
  const isContentConfigJsFile = [".js", ".mjs"].some(
    (ext) => contentPaths.config.url.pathname.endsWith(ext)
  );
  if (!isContentConfigJsFile)
    return;
  const inputConfig = loadTSConfig(fileURLToPath(settings.config.root), false);
  const tsConfigFileName = inputConfig.exists && inputConfig.path.split(path.sep).pop();
  if (!tsConfigFileName)
    return;
  const contentConfigFileName = contentPaths.config.url.pathname.split(path.sep).pop();
  const allowJSOption = (_b = (_a = inputConfig == null ? void 0 : inputConfig.config) == null ? void 0 : _a.compilerOptions) == null ? void 0 : _b.allowJs;
  const hasAllowJs = allowJSOption === true || tsConfigFileName === "jsconfig.json" && allowJSOption !== false;
  if (hasAllowJs)
    return;
=======
  logger,
  tsConfigFileName,
  contentConfigFileName
}) {
  logger.warn(
    "content",
    `Make sure you have the ${bold("allowJs")} compiler option set to ${bold(
      "true"
    )} in your ${bold(tsConfigFileName)} file to have autocompletion in your ${bold(
      contentConfigFileName
    )} file. See ${underline(
      cyan("https://www.typescriptlang.org/tsconfig#allowJs")
    )} for more information.`
  );
}
async function getTSConfigStatsWhenAllowJsFalse({
  contentPaths,
  settings
}) {
  const isContentConfigJsFile = [".js", ".mjs"].some(
    (ext) => contentPaths.config.url.pathname.endsWith(ext)
  );
  if (!isContentConfigJsFile) return;
  const inputConfig = await loadTSConfig(fileURLToPath(settings.config.root));
  if (typeof inputConfig === "string") return;
  const tsConfigFileName = inputConfig.tsconfigFile.split(path.sep).pop();
  if (!tsConfigFileName) return;
  const contentConfigFileName = contentPaths.config.url.pathname.split(path.sep).pop();
  const allowJSOption = inputConfig.tsconfig.compilerOptions?.allowJs;
  if (allowJSOption) return;
>>>>>>> 08f40ceb (Initial)
  return { tsConfigFileName, contentConfigFileName };
}
export {
  attachContentServerListeners
};
